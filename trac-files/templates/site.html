<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:i18n="http://genshi.edgewall.org/i18n"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      py:strip="">

    <!--! Add some tasty meta tags. -->
    <head py:match="head">
        <meta name="ROBOTS" content="NOODP" />
        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />
        <link rel="stylesheet" href="${chrome.htdocs_location}css/bootstrap.min.css" />
        <script type="text/javascript" src="${chrome.htdocs_location}js/jquery-1.7.1.min.js"></script>
        ${select('*|comment()|text()')}
        <script type="text/javascript" src="https://www.google.com/jsapi?key=ABQIAAAAJE-f7vmwI1-jxkmwRe4lUxTAs18ELyhzmLGaHoc1qJwmpJy3zhR3LMRRdwqg5PSY4tnVO684msUklQ"></script>
        <script type="text/javascript" src="${chrome.htdocs_location}js/bootstrap.min.js"></script>
        <script type="text/javascript" src="${chrome.htdocs_location}js/twisted.js"></script>
    </head>

    <!--! Add our own top-level navigation links. -->
    <div py:match="div[@id='banner']" py:attrs="select('@*')">
        <div id="top_grad"></div>
        <div id="tab">
            <a href="${href.wiki()}">HOME</a>
            <a href="${href.wiki('FrequentlyAskedQuestions')}">FAQ</a>
            <a href="${href.wiki('Documentation')}">DOCS</a>
            <a href="${href.wiki('Downloads')}">DOWNLOAD</a>
        </div>
        ${select('*|comment()|text()')}
    </div>

    <!--! Our own custom footer -->
    <div py:match="div[@id='footer']" py:attrs="select('@*')">
        <div class="sitemeter">
            <!--WEBBOT bot="HTMLMarkup" startspan ALT="Site Meter" -->
            <!--
            <script type="text/javascript" language="JavaScript">var site="sm7twistedmatrix"</script>
            <script type="text/javascript" language="JavaScript1.2" src="http://sm7.sitemeter.com/js/counter.js?site=sm7twistedmatrix"></script>
            <noscript>
                -->
                <a href="http://sm7.sitemeter.com/stats.asp?site=sm7twistedmatrix" target="_top">
                    <img src="http://sm7.sitemeter.com/meter.asp?site=sm7twistedmatrix" alt="Site Meter" border="0" />
                </a>
            <!-- </noscript> -->
            <!-- Copyright (c)2002 Site Meter -->
            <!--WEBBOT bot="HTMLMarkup" Endspan -->

            <!-- Google analytics, obviously. -->
            <script src="http://www.google-analytics.com/urchin.js" type="text/javascript" />
            <script type="text/javascript">
                _uacct = "UA-99018-6";
                urchinTracker();
            </script>
        </div>
        <div class="credits">
            <p><a href="${href.wiki('SiteCredits')}">Site design credits</a></p>
        </div>
        <div class="right">
            <p>${chrome.footer}</p>
        </div>
    </div>

    <!--! A more structured form of the ticket resolution, status and type attributes -->
    <div py:match="div[@id='content' and @class='ticket']" py:attrs="select('@*')">
        <span class="statuses" py:match="span[@class='status']">
            <py:if test="ticket.type"><span class="type">${ticket.type}</span></py:if>
            <py:if test="ticket.status"><span class="status">${ticket.status}</span></py:if>
            <py:if test="ticket.resolution"><span class="resolution">${ticket.resolution}</span></py:if>
        </span>
        <h1 py:match="h1">
            <span class="title">${select('text()')}</span>
            ${select('*|comment()')}
        </h1>
        ${select('*|comment()|text()')}
    </div>

    <!--! Genshi, like all write-your-logic-in-your-template languages, is
          completely and utterly terrible. The context in which the variable
          "change" occurs is completely lost and so our only option appears to
          be to reproduce the entire loop. Goodie. -->
    <div py:match="div[@id='changelog']" py:attrs="select('@*')">
      <py:for each="change in changes"
              py:with="can_edit_comment = has_edit_comment or (authname and authname != 'anonymous'
                                                               and authname == change.author);
                       show_editor = can_edit_comment and str(change.cnum) == cnum_edit;
                       show_history = str(change.cnum) == cnum_hist;
                       max_version = max(change.comment_history);
                       comment_version = (max_version, int(cversion or 0))[show_history]">
        <div class="change" id="${'cnum' in change and 'trac-change-%d' % change.cnum or None}">
          <h3 class="change">
            <span class="threading" py:if="'cnum' in change"
                  py:with="change_replies = replies.get(str(change.cnum), [])">
              <span id="comment:$change.cnum" class="cnum">${commentref('', change.cnum)}</span>
              <py:if test="change_replies or 'replyto' in change">
                <py:if test="'replyto' in change">
                  in reply to: ${commentref('&uarr;&nbsp;', change.replyto)}
                  <py:if test="change_replies">; </py:if>
                </py:if>
                <py:if test="change_replies">
                  <i18n:choose numeral="len(change_replies)">
                    <span i18n:singular="">follow-up:</span>
                    <span i18n:plural="">follow-ups:</span>
                  </i18n:choose>
                  <py:for each="reply in change_replies">
                    ${commentref('&darr;&nbsp;', reply)}
                  </py:for></py:if>
              </py:if>
            </span>
            <i18n:msg params="date, author">Changed ${dateinfo(change.date)} ago by ${authorinfo(change.author)}</i18n:msg>
          </h3>
          <py:if test="not show_editor and comment_version == max_version">
            <form py:if="'cnum' in change and can_edit_comment" method="get" action="#comment:${change.cnum}">
              <div class="inlinebuttons">
                <input type="hidden" name="cnum_edit" value="${change.cnum}"/>
                <input type="submit" value="${_('Edit')}" title="${_('Edit comment %(cnum)s', cnum=change.cnum)}"/>
              </div>
            </form>
            <form py:if="'cnum' in change and can_append" id="reply-to-comment-${change.cnum}"
                  method="get" action="#comment">
              <div class="inlinebuttons">
                <input type="hidden" name="replyto" value="${change.cnum}"/>
                <input type="submit" value="${_('Reply')}" title="${_('Reply to comment %(cnum)s', cnum=change.cnum)}"/>
              </div>
            </form>
          </py:if>
          <xi:include href="ticket_change.html"/>
          <div py:if="not show_editor and len(change.comment_history) > 1" py:choose=""
               class="trac-lastedit ${comment_version != max_version and 'trac-shade' or None}">
            <i18n:msg params="version, date, author" py:when="comment_version != max_version">
                Version ${comment_version}, edited ${dateinfo(change.comment_history[comment_version].date)} ago
                by ${authorinfo(change.comment_history[comment_version].author)}
            </i18n:msg>
            <i18n:msg params="date, author" py:otherwise="">
                Last edited ${dateinfo(change.comment_history[comment_version].date)} ago
                by ${authorinfo(change.comment_history[comment_version].author)}
            </i18n:msg>
            <py:if test="comment_version > 0">
              (<a href="${href.ticket(ticket.id, cnum_hist=change.cnum, cversion=comment_version - 1)
                         }#comment:${change.cnum}">previous</a>)
            </py:if>
            <py:if test="comment_version &lt; max_version">
              (<a href="${href.ticket(ticket.id, cnum_hist=change.cnum, cversion=comment_version + 1)
                         }#comment:${change.cnum}">next</a>)
            </py:if>
            <py:if test="comment_version > 0">
              (<a href="${href.ticket(ticket.id, action='comment-diff', cnum=change.cnum, 
                                      version=comment_version)}">diff</a>)
            </py:if>
          </div>
        </div>
      </py:for>
    </div>

    <!--! Don't allow replacing existing attachments, ever. -->
    <py:match path="form[@id='attachment']//div[@class='options']" />

    <!--! Show a reminder on the attachment page about including tests. -->
    <py:match path="form[@id='attachment']/div[@class='buttons']">
        <p>
        Adding a patch that changes code? Make sure it includes unit tests!
        <a href="/trac/wiki/ReviewProcess">See the complete acceptance criteria</a>. Thanks!
        </p>
        <div py:attrs="select('@*')">
            ${select('*|comment()|text()')}
        </div>
    </py:match>

    <!--! Add links to diffresource and buildbot -->
    <py:match path="td[@headers='h_branch']">
      <td headers="h_branch">
        ${ticket['branch']}
        <py:if test="ticket['branch']">
          <br/>
          (<a href="/~diffresource.twistd/${ticket.id}">diff</a>,
          <a href="http://buildbot.twistedmatrix.com/boxes-supported?branch=${ticket['branch']}">buildbot</a>)
        </py:if>
      </td>
    </py:match>
</html>
